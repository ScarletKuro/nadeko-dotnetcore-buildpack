#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

### Configure environment
set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output
set -o nounset    # fail on unset variables
unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps

### Configure directories
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd $(dirname ${0:-}); cd ..; pwd)

# down here is workind dotnet core release url
# 1.0.0-preview2-003131 < latest working
# 1.0.0-preview4-004107 < latest
# 1.0.0-preview2-1-003177 - trial
# latest < default
# now using - latest

DOTNET_VERSION="1.0.0-preview2-1-003177" # TODO make it be got from project.json
NODE_VERSION="6.9.1"

mkdir -p $BUILD_DIR/.profile.d
cp $BP_DIR/profile/* $BUILD_DIR/.profile.d/

### Load dependencies
source $BP_DIR/lib/utils

echo "Installing the dependencies"
apt_install libunwind8 gettext

install_node $BUILD_DIR $NODE_VERSION
install_dotnet $BUILD_DIR $DOTNET_VERSION

export PATH="/app/dotnet:${PATH}"
export LD_LIBRARY_PATH="${LD_LIBRARY_PATH}"


cd $BUILD_DIR
dotnet restore


echo "Restoring Nadeko dependencies"
cd $BUILD_DIR/NadekoBot/Discord.Net/src/Discord.Net.Core/
dotnet restore 1>/dev/null 2>&1
cd $BUILD_DIR/NadekoBot/Discord.Net/src/Discord.Net.Rest/
dotnet restore 1>/dev/null 2>&1
cd $BUILD_DIR/NadekoBot/Discord.Net/src/Discord.Net.WebSocket/
dotnet restore 1>/dev/null 2>&1
cd $BUILD_DIR/NadekoBot/Discord.Net/src/Discord.Net.Commands/
dotnet restore 1>/dev/null 2>&1
cd $BUILD_DIR/NadekoBot/src/NadekoBot/
dotnet restore 1>/dev/null 2>&1
echo ""
echo "Restoring done"

echo "Building NadekoBot"
cd $BUILD_DIR/NadekoBot/src/NadekoBot/
dotnet build --configuration Release 1>/dev/null 2>&1
echo ""
echo "Installation Complete."